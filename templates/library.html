<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <style>
        /* Theme Variables */
        :root {
            --bg-main: #f4f4f9;
            --bg-card: #ffffff;
            --bg-dropzone: #f8fbff;
            --bg-dropzone-hover: #f1f7ff;
            --bg-dropzone-drag: #e8f1ff;
            --text-primary: #2c3e50;
            --text-secondary: #666666;
            --text-muted: #6c757d;
            --text-status: #444444;
            --border-light: #dddddd;
            --border-medium: #e8e8ef;
            --border-dropzone: #b7c5d6;
            --border-dropzone-hover: #4a90e2;
            --border-dropzone-drag: #2c7df0;
            --accent-primary: #3498db;
            --accent-primary-hover: #2d89c8;
            --accent-secondary: #2980b9;
            --shadow-card: rgba(0,0,0,0.1);
            --shadow-upload: rgba(0,0,0,0.08);
            --shadow-dropzone: rgba(76,131,255,0.18);
        }

        body.dark-mode {
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --bg-dropzone: #3d3d3d;
            --bg-dropzone-hover: #4a4a4a;
            --bg-dropzone-drag: #505050;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #888888;
            --text-status: #b0b0b0;
            --border-light: #4a4a4a;
            --border-medium: #3d3d3d;
            --border-dropzone: #5a5a5a;
            --border-dropzone-hover: #7db8f5;
            --border-dropzone-drag: #7db8f5;
            --accent-primary: #7db8f5;
            --accent-primary-hover: #5ca3e8;
            --accent-secondary: #5ca3e8;
            --shadow-card: rgba(0,0,0,0.3);
            --shadow-upload: rgba(0,0,0,0.2);
            --shadow-dropzone: rgba(125,184,245,0.2);
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-main); margin: 0; padding: 40px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 900px; margin: 0 auto; position: relative; }
        h1 { color: var(--text-primary); border-bottom: 2px solid var(--border-light); padding-bottom: 10px; transition: color 0.3s, border-color 0.3s; }
        .upload-card { background: var(--bg-card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 14px var(--shadow-upload); margin: 20px 0 30px; border: 1px solid var(--border-medium); transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s; }
        .upload-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .upload-title { font-weight: 700; color: var(--text-primary); font-size: 1.1em; transition: color 0.3s; }
        .upload-desc { color: var(--text-muted); margin: 8px 0 16px; font-size: 0.95em; transition: color 0.3s; }
        .dropzone { border: 2px dashed var(--border-dropzone); border-radius: 10px; padding: 24px; background: var(--bg-dropzone); text-align: center; cursor: pointer; transition: all 0.3s; color: var(--text-secondary); }
        .dropzone:hover { border-color: var(--border-dropzone-hover); background: var(--bg-dropzone-hover); }
        .dropzone.dragging { border-color: var(--border-dropzone-drag); background: var(--bg-dropzone-drag); box-shadow: 0 8px 20px var(--shadow-dropzone); }
        .upload-actions { margin-top: 14px; display: flex; align-items: center; gap: 12px; }
        .upload-btn { background: var(--accent-primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
        .upload-btn:hover { background: var(--accent-primary-hover); }
        .upload-status { color: var(--text-status); font-size: 0.95em; min-height: 20px; transition: color 0.3s; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .book-card { background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-card); transition: all 0.3s; }
        .book-title { font-size: 1.2em; font-weight: bold; color: var(--text-primary); margin-bottom: 10px; transition: color 0.3s; }
        .book-meta { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 15px; transition: color 0.3s; }
        .btn { display: inline-block; background: var(--accent-primary); color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; transition: background-color 0.3s; }
        .btn:hover { background: var(--accent-secondary); }

        /* Header Actions */
        .header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .highlights-link { background: var(--accent-primary); color: white; text-decoration: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; font-size: 0.95em; }
        .highlights-link:hover { background: var(--accent-primary-hover); }
        .theme-toggle { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-medium); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2em; transition: all 0.3s; }
        .theme-toggle:hover { background: var(--bg-dropzone-hover); border-color: var(--border-dropzone-hover); }

        /* Tag Filter Bar */
        .tag-filter-bar { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-filter-btn { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-medium); padding: 6px 14px; border-radius: 16px; cursor: pointer; font-size: 0.9em; font-family: -apple-system, sans-serif; transition: all 0.3s; }
        .tag-filter-btn:hover { background: var(--bg-dropzone-hover); border-color: var(--border-dropzone-hover); }
        .tag-filter-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); font-weight: 600; }

        /* Tag Badges on Book Cards */
        .book-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; min-height: 24px; }
        .tag-badge { display: inline-block; background: var(--accent-primary); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; font-family: -apple-system, sans-serif; }
        .tag-badge.empty-placeholder { opacity: 0; pointer-events: none; }

        /* Edit Tags Button */
        .edit-tags-btn { display: inline-block; background: transparent; color: var(--accent-primary); border: 1px solid var(--accent-primary); text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: all 0.3s; margin-top: 10px; }
        .edit-tags-btn:hover { background: var(--accent-primary); color: white; }

        /* Tag Editor Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.3em; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .modal-subtext { color: var(--text-muted); font-size: 0.9em; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: 6px; font-size: 1em; background: var(--bg-main); color: var(--text-primary); box-sizing: border-box; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .modal-btn-primary { background: var(--accent-primary); color: white; }
        .modal-btn-primary:hover { background: var(--accent-primary-hover); }
        .modal-btn-secondary { background: var(--border-medium); color: var(--text-primary); }
        .modal-btn-secondary:hover { background: var(--border-dark); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-wrapper">
            <h1 style="margin: 0; border: none; padding: 0;">Library</h1>
            <div class="header-actions">
                <a href="{{ root_path }}/highlights" class="highlights-link">
                    ✨ Highlights
                </a>
                <button class="theme-toggle" id="themeToggle" onclick="toggleDarkMode()" title="Toggle dark mode">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" id="themeIcon">
                        <!-- Moon icon (default for light mode) -->
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="upload-card">
            <div class="upload-header">
                <div class="upload-title">Add a book</div>
                <button class="upload-btn" id="chooseBtn" type="button">Choose EPUB/PDF</button>
            </div>
            <div class="upload-desc">Drag & drop a .epub or .pdf file or click to pick one. The book will be processed locally and added to your library.</div>
            <div class="dropzone" id="dropzone">Drop .epub or .pdf here</div>
            <div class="upload-actions">
                <input type="file" id="fileInput" accept=".epub,.pdf" style="display:none">
                <span class="upload-status" id="uploadStatus"></span>
            </div>
        </div>

        <!-- Tag Filter Bar -->
        {% if all_tags %}
        <div class="tag-filter-section" style="margin: 30px 0 20px 0;">
            <div style="font-family: -apple-system, sans-serif; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; font-size: 1.05em;">Filter by Tags</div>
            <div class="tag-filter-bar">
                <button class="tag-filter-btn active" data-tag="all" onclick="filterByTags('all')">
                    All Books
                </button>
                {% for tag in all_tags %}
                <button class="tag-filter-btn" data-tag="{{ tag }}" onclick="toggleTagFilter('{{ tag }}')">
                    {{ tag }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if not books %}
            <p>No processed books found. Upload an EPUB/PDF above or run <code>reader3.py</code> on a book first.</p>
        {% endif %}

        <div class="book-grid">
            {% for book in books %}
            <div class="book-card" data-tags="{{ ','.join(book.tags) }}">
                <div class="book-title">{{ book.title }}</div>
                <div class="book-tags">
                    {% if book.tags %}
                        {% for tag in book.tags %}
                        <span class="tag-badge">{{ tag }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="tag-badge empty-placeholder">no tags</span>
                    {% endif %}
                </div>
                <div class="book-meta">
                    {{ book.author }}<br>
                    {{ book.chapters }} sections
                </div>
                <a href="{{ root_path }}/read/{{ book.id }}/0" class="btn">Read Book</a>
                <button class="edit-tags-btn" onclick="openTagEditor('{{ book.id }}', '{{ ','.join(book.tags) }}', '{{ book.title }}')">Edit Tags</button>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const chooseBtn = document.getElementById('chooseBtn');
        const statusEl = document.getElementById('uploadStatus');

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.style.color = isError ? '#d6336c' : '#444';
        }

        async function uploadFile(file) {
            if (!file) return;
            const lower = file.name.toLowerCase();
            if (!lower.endsWith('.epub') && !lower.endsWith('.pdf')) {
                setStatus('Please select an .epub or .pdf file', true);
                return;
            }

            setStatus('Uploading…');
            const data = new FormData();
            data.append('file', file, file.name);

            try {
                const res = await fetch('{{ root_path }}/upload', { method: 'POST', body: data });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) {
                    setStatus(body.detail || 'Upload failed', true);
                    return;
                }
                setStatus(`Added "${body.title}"`, false);
                setTimeout(() => window.location.reload(), 400);
            } catch (err) {
                setStatus('Upload failed. Is the server running?', true);
            }
        }

        dropzone.addEventListener('click', () => fileInput.click());
        chooseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => uploadFile(e.target.files[0]));

        ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.add('dragging');
        }));

        ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragging');
        }));

        dropzone.addEventListener('drop', (e) => {
            if (e.dataTransfer?.files?.length) {
                uploadFile(e.dataTransfer.files[0]);
            }
        });

        // Prevent the browser from opening dropped files outside the dropzone.
        ['dragover', 'drop'].forEach(evt => document.body.addEventListener(evt, (e) => {
            e.preventDefault();
        }));

        // Dark Mode Functions
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('themeIcon');
            if (isDark) {
                // Sun icon for dark mode (click to go light)
                icon.innerHTML = '<path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path>';
            } else {
                // Moon icon for light mode (click to go dark)
                icon.innerHTML = '<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>';
            }
        }

        function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function initTheme() {
            // Check localStorage first, then system preference
            let theme = localStorage.getItem('theme');
            if (!theme) {
                // Check system preference
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeIcon(true);
            }
        }

        // Initialize theme on page load
        initTheme();

        // ===== Tag Management =====

        let currentBookId = null;
        const selectedTags = new Set();

        function openTagEditor(bookId, currentTags, bookTitle) {
            currentBookId = bookId;
            document.getElementById('modalBookTitle').textContent = bookTitle;
            document.getElementById('tagInput').value = currentTags;
            document.getElementById('tagModal').classList.add('show');
            document.getElementById('tagInput').focus();
        }

        function closeTagEditor() {
            document.getElementById('tagModal').classList.remove('show');
            currentBookId = null;
        }

        async function saveTags() {
            if (!currentBookId) return;

            const input = document.getElementById('tagInput').value;
            const tags = input.split(',').map(t => t.trim()).filter(t => t.length > 0);

            try {
                const res = await fetch(`{{ root_path }}/api/books/${currentBookId}/tags`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tags })
                });

                if (!res.ok) {
                    const error = await res.json();
                    alert(`Failed to save tags: ${error.detail || 'Unknown error'}`);
                    return;
                }

                // Reload page to show updated tags
                window.location.reload();
            } catch (err) {
                alert(`Failed to save tags: ${err.message}`);
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('tagModal').classList.contains('show')) {
                closeTagEditor();
            }
        });

        // Close modal when clicking outside
        document.getElementById('tagModal').addEventListener('click', (e) => {
            if (e.target.id === 'tagModal') {
                closeTagEditor();
            }
        });

        // ===== Tag Filtering =====

        function filterByTags(tag) {
            // Clear all selections
            selectedTags.clear();
            document.querySelectorAll('.tag-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (tag === 'all') {
                // Show all books
                document.querySelectorAll('.book-card').forEach(card => {
                    card.style.display = 'block';
                });
                document.querySelector('[data-tag="all"]').classList.add('active');
            } else {
                // Single tag filter (shouldn't normally be called, but keep for safety)
                selectedTags.add(tag);
                applyFilters();
            }
        }

        function toggleTagFilter(tag) {
            const btn = document.querySelector(`[data-tag="${tag}"]`);

            // Toggle tag selection
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
                btn.classList.remove('active');
            } else {
                selectedTags.add(tag);
                btn.classList.add('active');
            }

            // Deactivate "All" button
            document.querySelector('[data-tag="all"]').classList.remove('active');

            // If no tags selected, show all
            if (selectedTags.size === 0) {
                filterByTags('all');
                return;
            }

            applyFilters();
        }

        function applyFilters() {
            // OR logic: Show books that have ANY of the selected tags
            document.querySelectorAll('.book-card').forEach(card => {
                const bookTags = card.dataset.tags.split(',').filter(t => t);

                // Check if book has any of the selected tags
                const hasMatch = bookTags.some(bookTag => selectedTags.has(bookTag));

                card.style.display = hasMatch ? 'block' : 'none';
            });
        }
    </script>

    <!-- Tag Editor Modal -->
    <div id="tagModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Tags</div>
            <div class="modal-subtext" id="modalBookTitle"></div>
            <input type="text" id="tagInput" class="modal-input" placeholder="Enter tags separated by commas (e.g., trading, finance, options)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeTagEditor()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveTags()">Save Tags</button>
            </div>
        </div>
    </div>
</body>
</html>
