<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <style>
        :root {
            --bg-main: #fafafa;
            --bg-card: #ffffff;
            --bg-card-hover: #f8f9fa;
            --bg-dropzone: #f8fafc;
            --bg-dropzone-hover: #f1f5f9;
            --bg-dropzone-drag: #e2e8f0;
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-subtle: #e2e8f0;
            --border-medium: #cbd5e1;
            --accent-primary: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-light: #dbeafe;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --radius-sm: 6px;
            --radius-md: 10px;
            --transition: 0.2s ease;
        }

        body.dark-mode {
            --bg-main: #0f0f0f;
            --bg-card: #1a1a1a;
            --bg-card-hover: #242424;
            --bg-dropzone: #1e1e1e;
            --bg-dropzone-hover: #2a2a2a;
            --bg-dropzone-drag: #333333;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --border-subtle: #2a2a2a;
            --border-medium: #3a3a3a;
            --accent-primary: #3b82f6;
            --accent-hover: #60a5fa;
            --accent-light: #1e3a5f;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            transition: background-color var(--transition), color var(--transition);
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.025em;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            text-decoration: none;
            border: none;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 8px;
        }
        .btn-ghost:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-sm);
        }

        .upload-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .upload-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dropzone {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-sm);
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        .dropzone:hover {
            border-color: var(--accent-primary);
            background: var(--bg-dropzone-hover);
            color: var(--text-secondary);
        }
        .dropzone.dragging {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        .upload-status {
            margin-top: 12px;
            font-size: 0.875rem;
            color: var(--text-muted);
            min-height: 20px;
        }
        .upload-status.error { color: #dc2626; }

        /* Book List */
        .book-list {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        /* Tag Section */
        .tag-section { }

        .tag-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
            user-select: none;
            margin-bottom: 8px;
        }
        .tag-header:hover .tag-title {
            color: var(--accent-primary);
        }

        .tag-icon {
            font-size: 0.625rem;
            color: var(--text-muted);
            transition: transform var(--transition);
        }
        .tag-section.collapsed .tag-icon {
            transform: rotate(-90deg);
        }

        .tag-title {
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            transition: color var(--transition);
        }

        .tag-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .tag-books {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .tag-section.collapsed .tag-books {
            display: none;
        }

        /* Book Row */
        .book-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            text-decoration: none;
            transition: all var(--transition);
            border: 1px solid transparent;
        }
        .book-row:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-subtle);
        }

        .book-info {
            flex: 1;
            min-width: 0;
        }

        .book-title {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 2px;
        }

        .book-author {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .book-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .progress-track {
            width: 60px;
            height: 3px;
            background: var(--border-subtle);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            min-width: 32px;
            text-align: right;
        }

        .book-tags-btn {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .book-tags-btn:hover {
            background: var(--border-subtle);
            color: var(--text-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state p {
            font-size: 0.9375rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-md);
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .modal-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: border-color var(--transition);
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .modal-btn-cancel {
            background: var(--border-subtle);
            color: var(--text-primary);
        }
        .modal-btn-cancel:hover {
            background: var(--border-medium);
        }
        .modal-btn-save {
            background: var(--accent-primary);
            color: white;
        }
        .modal-btn-save:hover {
            background: var(--accent-hover);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: 24px 16px;
            }
            .header {
                margin-bottom: 28px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .book-row {
                flex-wrap: wrap;
                gap: 12px;
            }
            .book-info {
                width: 100%;
            }
            .book-progress {
                flex: 1;
            }
            .progress-track {
                flex: 1;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Library</h1>
            <div class="header-actions">
                <a href="{{ root_path }}/highlights" class="btn btn-primary">Highlights</a>
                <button class="btn btn-ghost" id="themeToggle" onclick="toggleDarkMode()" title="Toggle dark mode">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" id="themeIcon">
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <section class="upload-section">
            <div class="upload-header">
                <span class="upload-title">Add a book</span>
                <button class="btn btn-primary" id="chooseBtn" type="button">Choose file</button>
            </div>
            <div class="dropzone" id="dropzone">Drop EPUB or PDF here, or click to browse</div>
            <input type="file" id="fileInput" accept=".epub,.pdf" style="display:none">
            <div class="upload-status" id="uploadStatus"></div>
        </section>

        {% if not books %}
            <div class="empty-state">
                <p>No books in your library yet. Upload an EPUB or PDF above to get started.</p>
            </div>
        {% else %}
            {% set books_by_tag = {} %}
            {% set untagged_books = [] %}
            {% for book in books %}
                {% if book.tags %}
                    {% for tag in book.tags %}
                        {% if tag not in books_by_tag %}
                            {% set _ = books_by_tag.update({tag: []}) %}
                        {% endif %}
                        {% set _ = books_by_tag[tag].append(book) %}
                    {% endfor %}
                {% else %}
                    {% set _ = untagged_books.append(book) %}
                {% endif %}
            {% endfor %}

            <div class="book-list">
                {% for tag in all_tags %}
                    {% if tag in books_by_tag %}
                    <div class="tag-section" data-tag="{{ tag }}">
                        <div class="tag-header" onclick="toggleSection(this)">
                            <span class="tag-icon">▼</span>
                            <span class="tag-title">{{ tag }}</span>
                            <span class="tag-count">{{ books_by_tag[tag]|length }}</span>
                        </div>
                        <div class="tag-books">
                            {% for book in books_by_tag[tag] %}
                            <a href="{{ root_path }}/read/{{ book.id }}/{{ book.last_chapter }}" class="book-row">
                                <div class="book-info">
                                    <div class="book-title">{{ book.title }}</div>
                                    <div class="book-author">{{ book.author }}</div>
                                </div>
                                <div class="book-progress">
                                    <div class="progress-track"><div class="progress-fill" style="width: {{ book.progress }}%"></div></div>
                                    <span class="progress-text">{{ book.progress|int }}%</span>
                                </div>
                                <button class="book-tags-btn" onclick="event.preventDefault(); openTagEditor('{{ book.id }}', '{{ ','.join(book.tags) }}', '{{ book.title | replace("'", "\\'") }}')">Tags</button>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}

                {% if untagged_books %}
                <div class="tag-section" data-tag="untagged">
                    <div class="tag-header" onclick="toggleSection(this)">
                        <span class="tag-icon">▼</span>
                        <span class="tag-title">Untagged</span>
                        <span class="tag-count">{{ untagged_books|length }}</span>
                    </div>
                    <div class="tag-books">
                        {% for book in untagged_books %}
                        <a href="{{ root_path }}/read/{{ book.id }}/{{ book.last_chapter }}" class="book-row">
                            <div class="book-info">
                                <div class="book-title">{{ book.title }}</div>
                                <div class="book-author">{{ book.author }}</div>
                            </div>
                            <div class="book-progress">
                                <div class="progress-track"><div class="progress-fill" style="width: {{ book.progress }}%"></div></div>
                                <span class="progress-text">{{ book.progress|int }}%</span>
                            </div>
                            <button class="book-tags-btn" onclick="event.preventDefault(); openTagEditor('{{ book.id }}', '', '{{ book.title | replace("'", "\\'") }}')">Tags</button>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const chooseBtn = document.getElementById('chooseBtn');
        const statusEl = document.getElementById('uploadStatus');

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.classList.toggle('error', isError);
        }

        async function uploadFile(file) {
            if (!file) return;
            const lower = file.name.toLowerCase();
            if (!lower.endsWith('.epub') && !lower.endsWith('.pdf')) {
                setStatus('Please select an EPUB or PDF file', true);
                return;
            }
            setStatus('Uploading…');
            const data = new FormData();
            data.append('file', file, file.name);
            try {
                const res = await fetch('{{ root_path }}/upload', { method: 'POST', body: data });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) { setStatus(body.detail || 'Upload failed', true); return; }
                setStatus(`Added "${body.title}"`);
                setTimeout(() => window.location.reload(), 400);
            } catch (err) { setStatus('Upload failed. Is the server running?', true); }
        }

        dropzone.addEventListener('click', () => fileInput.click());
        chooseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => uploadFile(e.target.files[0]));
        ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragging'); }));
        ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragging'); }));
        dropzone.addEventListener('drop', (e) => { if (e.dataTransfer?.files?.length) uploadFile(e.dataTransfer.files[0]); });
        ['dragover', 'drop'].forEach(evt => document.body.addEventListener(evt, (e) => e.preventDefault()));

        function toggleSection(header) {
            const section = header.closest('.tag-section');
            section.classList.toggle('collapsed');
            const tag = section.dataset.tag;
            const collapsed = JSON.parse(localStorage.getItem('collapsedSections') || '{}');
            collapsed[tag] = section.classList.contains('collapsed');
            localStorage.setItem('collapsedSections', JSON.stringify(collapsed));
        }

        function restoreCollapsedState() {
            const collapsed = JSON.parse(localStorage.getItem('collapsedSections') || '{}');
            document.querySelectorAll('.tag-section').forEach(section => {
                if (collapsed[section.dataset.tag]) section.classList.add('collapsed');
            });
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('themeIcon');
            icon.innerHTML = isDark
                ? '<path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path>'
                : '<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>';
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function initTheme() {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') { document.body.classList.add('dark-mode'); updateThemeIcon(true); }
        }

        initTheme();
        restoreCollapsedState();

        let currentBookId = null;
        function openTagEditor(bookId, currentTags, bookTitle) {
            currentBookId = bookId;
            document.getElementById('modalBookTitle').textContent = bookTitle;
            document.getElementById('tagInput').value = currentTags;
            document.getElementById('tagModal').classList.add('show');
            document.getElementById('tagInput').focus();
        }
        function closeTagEditor() {
            document.getElementById('tagModal').classList.remove('show');
            currentBookId = null;
        }
        async function saveTags() {
            if (!currentBookId) return;
            const tags = document.getElementById('tagInput').value.split(',').map(t => t.trim()).filter(t => t);
            try {
                const res = await fetch(`{{ root_path }}/api/books/${currentBookId}/tags`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tags })
                });
                if (!res.ok) { alert(`Failed: ${(await res.json()).detail || 'Unknown error'}`); return; }
                window.location.reload();
            } catch (err) { alert(`Failed: ${err.message}`); }
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeTagEditor(); });
        document.getElementById('tagModal').addEventListener('click', (e) => { if (e.target.id === 'tagModal') closeTagEditor(); });
    </script>

    <div id="tagModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Edit Tags</h2>
            <p class="modal-subtitle" id="modalBookTitle"></p>
            <input type="text" id="tagInput" class="modal-input" placeholder="Enter tags separated by commas">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeTagEditor()">Cancel</button>
                <button class="modal-btn modal-btn-save" onclick="saveTags()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>
