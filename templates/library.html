<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <style>
        :root {
            --bg-main: #f4f4f9;
            --bg-card: #ffffff;
            --bg-dropzone: #f8fbff;
            --bg-dropzone-hover: #f1f7ff;
            --bg-dropzone-drag: #e8f1ff;
            --bg-row-hover: #f0f4f8;
            --text-primary: #2c3e50;
            --text-secondary: #666666;
            --text-muted: #6c757d;
            --text-status: #444444;
            --border-light: #dddddd;
            --border-medium: #e8e8ef;
            --border-dropzone: #b7c5d6;
            --border-dropzone-hover: #4a90e2;
            --border-dropzone-drag: #2c7df0;
            --accent-primary: #3498db;
            --accent-primary-hover: #2d89c8;
            --shadow-upload: rgba(0,0,0,0.08);
            --shadow-dropzone: rgba(76,131,255,0.18);
        }

        body.dark-mode {
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --bg-dropzone: #3d3d3d;
            --bg-dropzone-hover: #4a4a4a;
            --bg-dropzone-drag: #505050;
            --bg-row-hover: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #888888;
            --text-status: #b0b0b0;
            --border-light: #4a4a4a;
            --border-medium: #3d3d3d;
            --border-dropzone: #5a5a5a;
            --border-dropzone-hover: #7db8f5;
            --border-dropzone-drag: #7db8f5;
            --accent-primary: #7db8f5;
            --accent-primary-hover: #5ca3e8;
            --shadow-upload: rgba(0,0,0,0.2);
            --shadow-dropzone: rgba(125,184,245,0.2);
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-main); margin: 0; padding: 40px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 900px; margin: 0 auto; }

        /* Header */
        .header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header-wrapper h1 { margin: 0; color: var(--text-primary); font-size: 1.8em; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .highlights-link { background: var(--accent-primary); color: white; text-decoration: none; padding: 8px 14px; border-radius: 6px; font-weight: 600; font-size: 0.9em; transition: background 0.3s; }
        .highlights-link:hover { background: var(--accent-primary-hover); }
        .theme-toggle { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-medium); padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .theme-toggle:hover { background: var(--bg-dropzone-hover); border-color: var(--border-dropzone-hover); }

        /* Upload Card */
        .upload-card { background: var(--bg-card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 14px var(--shadow-upload); margin-bottom: 30px; border: 1px solid var(--border-medium); }
        .upload-header { display: flex; align-items: center; justify-content: space-between; }
        .upload-title { font-weight: 700; color: var(--text-primary); font-size: 1.1em; }
        .upload-desc { color: var(--text-muted); margin: 8px 0 16px; font-size: 0.95em; }
        .dropzone { border: 2px dashed var(--border-dropzone); border-radius: 10px; padding: 24px; background: var(--bg-dropzone); text-align: center; cursor: pointer; transition: all 0.3s; color: var(--text-secondary); }
        .dropzone:hover { border-color: var(--border-dropzone-hover); background: var(--bg-dropzone-hover); }
        .dropzone.dragging { border-color: var(--border-dropzone-drag); background: var(--bg-dropzone-drag); box-shadow: 0 8px 20px var(--shadow-dropzone); }
        .upload-actions { margin-top: 14px; display: flex; align-items: center; gap: 12px; }
        .upload-btn { background: var(--accent-primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.3s; }
        .upload-btn:hover { background: var(--accent-primary-hover); }
        .upload-status { color: var(--text-status); font-size: 0.95em; min-height: 20px; }

        /* Tag Sections */
        .tag-section { margin-bottom: 28px; }
        .tag-section-header { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 0; margin-bottom: 8px; user-select: none; }
        .tag-section-header:hover .tag-section-title { color: var(--accent-primary); }
        .collapse-icon { font-size: 0.7em; color: var(--text-muted); transition: transform 0.2s; }
        .tag-section.collapsed .collapse-icon { transform: rotate(-90deg); }
        .tag-section-title { font-size: 1.1em; font-weight: 600; color: var(--text-primary); margin: 0; transition: color 0.2s; }
        .tag-section-count { color: var(--text-muted); font-size: 0.85em; }
        .tag-section-books { display: flex; flex-direction: column; gap: 2px; }
        .tag-section.collapsed .tag-section-books { display: none; }

        /* Book Row */
        .book-row { display: flex; align-items: center; padding: 10px 14px; background: var(--bg-card); border-radius: 6px; cursor: pointer; transition: background 0.2s; text-decoration: none; gap: 16px; }
        .book-row:hover { background: var(--bg-row-hover); }
        .book-title { flex: 1; font-size: 0.95em; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { color: var(--text-secondary); font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .book-edit { color: var(--text-muted); font-size: 0.8em; padding: 4px 8px; border-radius: 4px; transition: color 0.2s; }
        .book-edit:hover { background: var(--border-medium); color: var(--text-primary); }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.3em; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .modal-subtext { color: var(--text-muted); font-size: 0.9em; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--border-medium); border-radius: 6px; font-size: 1em; background: var(--bg-main); color: var(--text-primary); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .modal-btn-primary { background: var(--accent-primary); color: white; }
        .modal-btn-primary:hover { background: var(--accent-primary-hover); }
        .modal-btn-secondary { background: var(--border-medium); color: var(--text-primary); }
        .modal-btn-secondary:hover { background: var(--border-light); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-wrapper">
            <h1>Library</h1>
            <div class="header-actions">
                <a href="{{ root_path }}/highlights" class="highlights-link">Highlights</a>
                <button class="theme-toggle" id="themeToggle" onclick="toggleDarkMode()" title="Toggle dark mode">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" id="themeIcon">
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="upload-card">
            <div class="upload-header">
                <div class="upload-title">Add a book</div>
                <button class="upload-btn" id="chooseBtn" type="button">Choose EPUB/PDF</button>
            </div>
            <div class="upload-desc">Drag & drop a .epub or .pdf file or click to pick one.</div>
            <div class="dropzone" id="dropzone">Drop .epub or .pdf here</div>
            <div class="upload-actions">
                <input type="file" id="fileInput" accept=".epub,.pdf" style="display:none">
                <span class="upload-status" id="uploadStatus"></span>
            </div>
        </div>

        {% if not books %}
            <div class="empty-state">
                <p>No books in your library yet. Upload an EPUB or PDF above to get started.</p>
            </div>
        {% else %}
            {% set books_by_tag = {} %}
            {% set untagged_books = [] %}
            {% for book in books %}
                {% if book.tags %}
                    {% for tag in book.tags %}
                        {% if tag not in books_by_tag %}
                            {% set _ = books_by_tag.update({tag: []}) %}
                        {% endif %}
                        {% set _ = books_by_tag[tag].append(book) %}
                    {% endfor %}
                {% else %}
                    {% set _ = untagged_books.append(book) %}
                {% endif %}
            {% endfor %}

            {% for tag in all_tags %}
                {% if tag in books_by_tag %}
                <div class="tag-section" data-tag="{{ tag }}">
                    <div class="tag-section-header" onclick="toggleSection(this)">
                        <span class="collapse-icon">▼</span>
                        <h2 class="tag-section-title">{{ tag }}</h2>
                        <span class="tag-section-count">({{ books_by_tag[tag]|length }})</span>
                    </div>
                    <div class="tag-section-books">
                        {% for book in books_by_tag[tag] %}
                        <a href="{{ root_path }}/read/{{ book.id }}/0" class="book-row">
                            <span class="book-title">{{ book.title }}</span>
                            <span class="book-author">{{ book.author }}</span>
                            <span class="book-edit" onclick="event.preventDefault(); openTagEditor('{{ book.id }}', '{{ ','.join(book.tags) }}', '{{ book.title | replace("'", "\\'") }}')">Tags</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}

            {% if untagged_books %}
            <div class="tag-section" data-tag="untagged">
                <div class="tag-section-header" onclick="toggleSection(this)">
                    <span class="collapse-icon">▼</span>
                    <h2 class="tag-section-title">Untagged</h2>
                    <span class="tag-section-count">({{ untagged_books|length }})</span>
                </div>
                <div class="tag-section-books">
                    {% for book in untagged_books %}
                    <a href="{{ root_path }}/read/{{ book.id }}/0" class="book-row">
                        <span class="book-title">{{ book.title }}</span>
                        <span class="book-author">{{ book.author }}</span>
                        <span class="book-edit" onclick="event.preventDefault(); openTagEditor('{{ book.id }}', '', '{{ book.title | replace("'", "\\'") }}')">Tags</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endif %}
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const chooseBtn = document.getElementById('chooseBtn');
        const statusEl = document.getElementById('uploadStatus');

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.style.color = isError ? '#d6336c' : 'var(--text-status)';
        }

        async function uploadFile(file) {
            if (!file) return;
            const lower = file.name.toLowerCase();
            if (!lower.endsWith('.epub') && !lower.endsWith('.pdf')) {
                setStatus('Please select an .epub or .pdf file', true);
                return;
            }
            setStatus('Uploading…');
            const data = new FormData();
            data.append('file', file, file.name);
            try {
                const res = await fetch('{{ root_path }}/upload', { method: 'POST', body: data });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) { setStatus(body.detail || 'Upload failed', true); return; }
                setStatus(`Added "${body.title}"`, false);
                setTimeout(() => window.location.reload(), 400);
            } catch (err) { setStatus('Upload failed. Is the server running?', true); }
        }

        dropzone.addEventListener('click', () => fileInput.click());
        chooseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => uploadFile(e.target.files[0]));
        ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragging'); }));
        ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragging'); }));
        dropzone.addEventListener('drop', (e) => { if (e.dataTransfer?.files?.length) uploadFile(e.dataTransfer.files[0]); });
        ['dragover', 'drop'].forEach(evt => document.body.addEventListener(evt, (e) => e.preventDefault()));

        function toggleSection(header) {
            const section = header.closest('.tag-section');
            section.classList.toggle('collapsed');
            const tag = section.dataset.tag;
            const collapsed = JSON.parse(localStorage.getItem('collapsedSections') || '{}');
            collapsed[tag] = section.classList.contains('collapsed');
            localStorage.setItem('collapsedSections', JSON.stringify(collapsed));
        }

        function restoreCollapsedState() {
            const collapsed = JSON.parse(localStorage.getItem('collapsedSections') || '{}');
            document.querySelectorAll('.tag-section').forEach(section => {
                if (collapsed[section.dataset.tag]) section.classList.add('collapsed');
            });
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('themeIcon');
            icon.innerHTML = isDark
                ? '<path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path>'
                : '<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>';
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function initTheme() {
            let theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') { document.body.classList.add('dark-mode'); updateThemeIcon(true); }
        }

        initTheme();
        restoreCollapsedState();

        let currentBookId = null;
        function openTagEditor(bookId, currentTags, bookTitle) {
            currentBookId = bookId;
            document.getElementById('modalBookTitle').textContent = bookTitle;
            document.getElementById('tagInput').value = currentTags;
            document.getElementById('tagModal').classList.add('show');
            document.getElementById('tagInput').focus();
        }
        function closeTagEditor() {
            document.getElementById('tagModal').classList.remove('show');
            currentBookId = null;
        }
        async function saveTags() {
            if (!currentBookId) return;
            const tags = document.getElementById('tagInput').value.split(',').map(t => t.trim()).filter(t => t);
            try {
                const res = await fetch(`{{ root_path }}/api/books/${currentBookId}/tags`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tags })
                });
                if (!res.ok) { alert(`Failed: ${(await res.json()).detail || 'Unknown error'}`); return; }
                window.location.reload();
            } catch (err) { alert(`Failed: ${err.message}`); }
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeTagEditor(); });
        document.getElementById('tagModal').addEventListener('click', (e) => { if (e.target.id === 'tagModal') closeTagEditor(); });
    </script>

    <div id="tagModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Tags</div>
            <div class="modal-subtext" id="modalBookTitle"></div>
            <input type="text" id="tagInput" class="modal-input" placeholder="Enter tags separated by commas">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeTagEditor()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveTags()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>
