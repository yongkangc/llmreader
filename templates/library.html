<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <link rel="stylesheet" href="{{ root_path }}/static/theme.css">
    <link rel="stylesheet" href="{{ root_path }}/static/app.css">
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-5);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-7);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        /* Add Book Section (bottom of page) */
        .add-book-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
            text-align: center;
        }

        .add-book-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: 1px dashed var(--border-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
        }
        .add-book-btn:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }
        .add-book-btn svg {
            width: 16px;
            height: 16px;
        }

        .dropzone {
            display: none;
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-md);
            padding: var(--space-7) var(--space-5);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-muted);
            font-size: 0.9375rem;
            margin-top: var(--space-4);
            background: var(--bg-surface);
        }
        .dropzone.show { display: block; }
        .dropzone:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            color: var(--text-primary);
        }
        .dropzone.dragging {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            color: var(--accent-primary);
            transform: scale(1.01);
        }

        .upload-status {
            margin-top: 12px;
            font-size: 0.875rem;
            color: var(--text-muted);
            min-height: 20px;
        }
        .upload-status.error { color: #dc2626; }

        /* Book List */
        .book-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        /* Tag Section */
        .tag-section { }

        .tag-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 0;
            cursor: pointer;
            user-select: none;
            margin-bottom: var(--space-2);
        }
        .tag-header:hover .tag-title {
            color: var(--accent-primary);
        }

        .tag-icon {
            font-size: 0.5rem;
            color: var(--text-muted);
            transition: transform var(--transition);
        }
        .tag-section.collapsed .tag-icon {
            transform: rotate(-90deg);
        }

        .tag-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            transition: color var(--transition);
        }

        .tag-count {
            display: none;
        }

        .tag-books {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-2);
        }
        .tag-section.collapsed .tag-books {
            display: none;
        }

        /* Book Row (Card) */
        .book-row {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            text-decoration: none;
            transition: all var(--ease) 0.2s;
            position: relative;
        }
        .book-row:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        /* Book Cover */
        .book-cover-container {
            width: 48px;
            height: 68px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--accent-light), var(--bg-surface));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .book-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-cover-fallback {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-primary);
            opacity: 0.5;
        }

        .book-info {
            flex: 1;
            min-width: 0;
        }

        .book-title {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .book-author {
            font-size: 0.8125rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .book-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .progress-track {
            width: 64px;
            height: 4px;
            background: var(--border-subtle);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: width 0.5s var(--ease);
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            min-width: 32px;
            text-align: right;
        }

        /* Secondary actions - hidden by default, shown on hover */
        .book-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity var(--transition);
        }
        .book-row:hover .book-actions {
            opacity: 1;
        }

        .book-tags-btn {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .book-tags-btn:hover {
            background: var(--border-subtle);
            color: var(--text-primary);
        }

        /* Delete Button */
        .book-delete-btn {
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .book-delete-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        body.dark-mode .book-delete-btn:hover {
            background: #450a0a;
            color: #f87171;
        }

        /* Offline Download Button */
        .book-offline-btn {
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        .book-offline-btn:hover {
            background: var(--accent-light);
            color: var(--accent-primary);
        }
        .book-offline-btn.downloaded {
            color: var(--accent-primary);
        }
        .book-offline-btn.downloading {
            color: #f59e0b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Offline status badge in header */
        .offline-status {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            background: var(--border-subtle);
            color: var(--text-muted);
        }
        .offline-status.online { background: #dcfce7; color: #16a34a; }
        .offline-status.offline { background: #fef3c7; color: #d97706; }
        body.dark-mode .offline-status.online { background: #14532d; color: #86efac; }
        body.dark-mode .offline-status.offline { background: #451a03; color: #fcd34d; }

        /* Storage usage indicator */
        .storage-usage {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            background: var(--border-subtle);
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
        }
        .storage-usage:hover {
            background: var(--bg-card-hover);
            color: var(--text-secondary);
        }
        .storage-usage.has-data {
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        /* Completed Checkbox */
        .book-completed-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
        }

        /* Completed section styling */
        .tag-section.completed-section .book-row {
            opacity: 0.6;
        }
        .tag-section.completed-section .book-row:hover {
            opacity: 1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state p {
            font-size: 0.9375rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-md);
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .modal-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: border-color var(--transition);
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .modal-btn-cancel {
            background: var(--border-subtle);
            color: var(--text-primary);
        }
        .modal-btn-cancel:hover {
            background: var(--border-medium);
        }
        .modal-btn-save {
            background: var(--accent-primary);
            color: white;
        }
        .modal-btn-save:hover {
            background: var(--accent-hover);
        }

        /* Delete Modal */
        .delete-modal {
            max-width: 400px;
        }
        .delete-warning {
            color: var(--text-muted);
            margin: 12px 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .delete-list {
            margin: 8px 0 16px 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .delete-list li {
            margin: 4px 0;
        }
        .modal-btn-danger {
            background: #dc2626;
            color: white;
        }
        .modal-btn-danger:hover {
            background: #b91c1c;
        }

        /* Tag Suggestions Pills */
        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            max-height: 120px;
            overflow-y: auto;
        }
        .tag-suggestions:empty {
            display: none;
        }
        .tag-suggestions-label {
            width: 100%;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .tag-pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 0.8rem;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition);
        }
        .tag-pill:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: var(--space-5) var(--space-4);
            }
            .tag-books {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            /* Always show actions on mobile (no hover) */
            .book-actions {
                opacity: 1;
            }
        }
    </style>
    <script src="{{ root_path }}/static/theme-toggle.js"></script>
    <script src="{{ root_path }}/static/offline-db.js"></script>
</head>
<body class="page-library">
    <div class="container">
        <header class="header">
            <h1>Library</h1>
            <div class="header-actions">
                <span class="storage-usage" id="storageUsage" title="Offline storage usage" onclick="showStorageDetails()">--</span>
                <span class="offline-status" id="offlineStatus">‚óè</span>
                <a href="{{ root_path }}/highlights" class="btn btn-primary">Highlights</a>
                <button class="btn btn-ghost" id="themeToggle" onclick="toggleDarkMode()" title="Toggle dark mode">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" id="themeIcon">
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>
                    </svg>
                </button>
            </div>
        </header>

        {% if not books %}
            <div class="empty-state">
                <p>No books in your library yet.</p>
            </div>
        {% else %}
            {% set books_by_tag = {} %}
            {% set untagged_books = [] %}
            {% set completed_books = [] %}
            {% for book in books %}
                {% if book.completed %}
                    {% set _ = completed_books.append(book) %}
                {% elif book.tags %}
                    {% for tag in book.tags %}
                        {% if tag not in books_by_tag %}
                            {% set _ = books_by_tag.update({tag: []}) %}
                        {% endif %}
                        {% set _ = books_by_tag[tag].append(book) %}
                    {% endfor %}
                {% else %}
                    {% set _ = untagged_books.append(book) %}
                {% endif %}
            {% endfor %}

            <div class="book-list">
                {% for tag in all_tags %}
                    {% if tag in books_by_tag %}
                    <div class="tag-section" data-tag="{{ tag }}">
                        <div class="tag-header" onclick="toggleSection(this)">
                            <span class="tag-icon">‚ñº</span>
                            <span class="tag-title">{{ tag }}</span>
                            <span class="tag-count">{{ books_by_tag[tag]|length }}</span>
                        </div>
                        <div class="tag-books">
                            {% for book in books_by_tag[tag] %}
                            <a href="{{ root_path }}/read/{{ book.id }}/{{ book.last_chapter }}" class="book-row">
                                <div class="book-cover-container">
                                    {% if book.cover_image %}
                                        <img class="book-cover-img" src="{{ root_path }}{{ book.cover_image }}" alt="" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                        <span class="book-cover-fallback" style="display:none">{{ book.title[0] }}</span>
                                    {% else %}
                                        <span class="book-cover-fallback">{{ book.title[0] }}</span>
                                    {% endif %}
                                </div>
                                <div class="book-info">
                                    <div class="book-title">{{ book.title }}</div>
                                    <div class="book-author">{{ book.author }}</div>
                                </div>
                                <div class="book-progress">
                                    <div class="progress-track"><div class="progress-fill" style="width: {{ book.progress }}%"></div></div>
                                    <span class="progress-text">{{ book.progress|int }}%</span>
                                </div>
                                <div class="book-actions" onclick="event.stopPropagation(); event.preventDefault();">
                                    <button class="book-offline-btn" data-book-id="{{ book.id }}" onclick="event.stopPropagation(); event.preventDefault(); toggleOfflineDownload('{{ book.id }}', this)" title="Download for offline">
                                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                                    </button>
                                    <button class="book-tags-btn" onclick="event.stopPropagation(); event.preventDefault(); openTagEditor('{{ book.id }}', '{{ ','.join(book.tags) }}', '{{ book.title | replace("'", "\\'") }}')">Tags</button>
                                    <button class="book-delete-btn" onclick="event.stopPropagation(); event.preventDefault(); openDeleteModal('{{ book.id }}', '{{ book.title | replace("'", "\\'") }}')" title="Delete book">
                                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                    </button>
                                    <input type="checkbox" class="book-completed-checkbox" title="Mark as completed" onclick="event.stopPropagation(); toggleCompleted('{{ book.id }}', this)" {% if book.completed %}checked{% endif %}>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}

                {% if untagged_books %}
                <div class="tag-section" data-tag="untagged">
                    <div class="tag-header" onclick="toggleSection(this)">
                        <span class="tag-icon">‚ñº</span>
                        <span class="tag-title">Untagged</span>
                        <span class="tag-count">{{ untagged_books|length }}</span>
                    </div>
                    <div class="tag-books">
                        {% for book in untagged_books %}
                        <a href="{{ root_path }}/read/{{ book.id }}/{{ book.last_chapter }}" class="book-row">
                            <div class="book-cover-container">
                                {% if book.cover_image %}
                                    <img class="book-cover-img" src="{{ root_path }}{{ book.cover_image }}" alt="" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                    <span class="book-cover-fallback" style="display:none">{{ book.title[0] }}</span>
                                {% else %}
                                    <span class="book-cover-fallback">{{ book.title[0] }}</span>
                                {% endif %}
                            </div>
                            <div class="book-info">
                                <div class="book-title">{{ book.title }}</div>
                                <div class="book-author">{{ book.author }}</div>
                            </div>
                            <div class="book-progress">
                                <div class="progress-track"><div class="progress-fill" style="width: {{ book.progress }}%"></div></div>
                                <span class="progress-text">{{ book.progress|int }}%</span>
                            </div>
                            <div class="book-actions" onclick="event.stopPropagation(); event.preventDefault();">
                                <button class="book-offline-btn" data-book-id="{{ book.id }}" onclick="event.stopPropagation(); event.preventDefault(); toggleOfflineDownload('{{ book.id }}', this)" title="Download for offline">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                                </button>
                                <button class="book-tags-btn" onclick="event.stopPropagation(); event.preventDefault(); openTagEditor('{{ book.id }}', '', '{{ book.title | replace("'", "\\'") }}')">Tags</button>
                                <button class="book-delete-btn" onclick="event.stopPropagation(); event.preventDefault(); openDeleteModal('{{ book.id }}', '{{ book.title | replace("'", "\\'") }}')" title="Delete book">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                </button>
                                <input type="checkbox" class="book-completed-checkbox" title="Mark as completed" onclick="event.stopPropagation(); toggleCompleted('{{ book.id }}', this)" {% if book.completed %}checked{% endif %}>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if completed_books %}
                <div class="tag-section completed-section collapsed" data-tag="completed">
                    <div class="tag-header" onclick="toggleSection(this)">
                        <span class="tag-icon">‚ñº</span>
                        <span class="tag-title">Completed</span>
                        <span class="tag-count">{{ completed_books|length }}</span>
                    </div>
                    <div class="tag-books">
                        {% for book in completed_books %}
                        <a href="{{ root_path }}/read/{{ book.id }}/{{ book.last_chapter }}" class="book-row">
                            <div class="book-cover-container">
                                {% if book.cover_image %}
                                    <img class="book-cover-img" src="{{ root_path }}{{ book.cover_image }}" alt="" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                    <span class="book-cover-fallback" style="display:none">{{ book.title[0] }}</span>
                                {% else %}
                                    <span class="book-cover-fallback">{{ book.title[0] }}</span>
                                {% endif %}
                            </div>
                            <div class="book-info">
                                <div class="book-title">{{ book.title }}</div>
                                <div class="book-author">{{ book.author }}</div>
                            </div>
                            <div class="book-progress">
                                <div class="progress-track"><div class="progress-fill" style="width: {{ book.progress }}%"></div></div>
                                <span class="progress-text">{{ book.progress|int }}%</span>
                            </div>
                            <div class="book-actions" onclick="event.stopPropagation(); event.preventDefault();">
                                <button class="book-offline-btn" data-book-id="{{ book.id }}" onclick="event.stopPropagation(); event.preventDefault(); toggleOfflineDownload('{{ book.id }}', this)" title="Download for offline">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                                </button>
                                <button class="book-tags-btn" onclick="event.stopPropagation(); event.preventDefault(); openTagEditor('{{ book.id }}', '{{ ','.join(book.tags) }}', '{{ book.title | replace("'", "\\'") }}')">Tags</button>
                                <button class="book-delete-btn" onclick="event.stopPropagation(); event.preventDefault(); openDeleteModal('{{ book.id }}', '{{ book.title | replace("'", "\\'") }}')" title="Delete book">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                </button>
                                <input type="checkbox" class="book-completed-checkbox" title="Mark as not completed" onclick="event.stopPropagation(); toggleCompleted('{{ book.id }}', this)" checked>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}

        <!-- Add Book Section -->
        <section class="add-book-section">
            <button class="add-book-btn" id="addBookBtn" type="button">
                <svg viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
                </svg>
                Add book
            </button>
            <div class="dropzone" id="dropzone">Drop EPUB or PDF here, or click to browse</div>
            <input type="file" id="fileInput" accept=".epub,.pdf" style="display:none">
            <div class="upload-status" id="uploadStatus"></div>
        </section>
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const addBookBtn = document.getElementById('addBookBtn');
        const statusEl = document.getElementById('uploadStatus');

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.classList.toggle('error', isError);
        }

        async function uploadFile(file) {
            if (!file) return;
            const lower = file.name.toLowerCase();
            if (!lower.endsWith('.epub') && !lower.endsWith('.pdf')) {
                setStatus('Please select an EPUB or PDF file', true);
                return;
            }
            setStatus('Uploading‚Ä¶');
            const data = new FormData();
            data.append('file', file, file.name);
            try {
                const res = await fetch('{{ root_path }}/upload', { method: 'POST', body: data });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) { setStatus(body.detail || 'Upload failed', true); return; }
                setStatus(`Added "${body.title}"`);
                setTimeout(() => window.location.reload(), 400);
            } catch (err) { setStatus('Upload failed. Is the server running?', true); }
        }

        addBookBtn.addEventListener('click', () => {
            dropzone.classList.toggle('show');
            if (dropzone.classList.contains('show')) {
                dropzone.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
        dropzone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => uploadFile(e.target.files[0]));
        ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragging'); }));
        ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragging'); }));
        dropzone.addEventListener('drop', (e) => { if (e.dataTransfer?.files?.length) uploadFile(e.dataTransfer.files[0]); });
        ['dragover', 'drop'].forEach(evt => document.body.addEventListener(evt, (e) => e.preventDefault()));

        function toggleSection(header) {
            const section = header.closest('.tag-section');
            section.classList.toggle('collapsed');
            const tag = section.dataset.tag;
            const collapsed = JSON.parse(localStorage.getItem('collapsedSections') || '{}');
            collapsed[tag] = section.classList.contains('collapsed');
            localStorage.setItem('collapsedSections', JSON.stringify(collapsed));
        }

        function restoreCollapsedState() {
            const collapsed = JSON.parse(localStorage.getItem('collapsedSections') || '{}');
            document.querySelectorAll('.tag-section').forEach(section => {
                if (collapsed[section.dataset.tag]) section.classList.add('collapsed');
            });
        }

        // Theme functions loaded from /static/theme-toggle.js
        restoreCollapsedState();

        let currentBookId = null;
        let allExistingTags = [];

        // Fetch all existing tags on page load
        async function loadExistingTags() {
            try {
                const res = await fetch(`{{ root_path }}/api/tags`);
                if (res.ok) {
                    const data = await res.json();
                    allExistingTags = data.tags || [];
                }
            } catch (err) {
                console.error('Failed to load tags:', err);
            }
        }
        loadExistingTags();

        function renderTagSuggestions(currentTags) {
            const container = document.getElementById('tagSuggestions');
            const currentTagList = currentTags.split(',').map(t => t.trim().toLowerCase()).filter(t => t);

            // Clear previous pills (keep the label)
            container.innerHTML = '<span class="tag-suggestions-label">Existing tags:</span>';

            // Filter out tags already in input
            const suggestions = allExistingTags.filter(tag =>
                !currentTagList.includes(tag.toLowerCase())
            );

            if (suggestions.length === 0) {
                container.innerHTML = '';
                return;
            }

            suggestions.forEach(tag => {
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'tag-pill';
                pill.textContent = tag;
                pill.onclick = () => addTagFromPill(tag);
                container.appendChild(pill);
            });
        }

        function addTagFromPill(tag) {
            const input = document.getElementById('tagInput');
            const currentTags = input.value.split(',').map(t => t.trim()).filter(t => t);

            if (!currentTags.map(t => t.toLowerCase()).includes(tag.toLowerCase())) {
                currentTags.push(tag);
                input.value = currentTags.join(', ');
            }

            renderTagSuggestions(input.value);
            input.focus();
        }

        function openTagEditor(bookId, currentTags, bookTitle) {
            currentBookId = bookId;
            document.getElementById('modalBookTitle').textContent = bookTitle;
            document.getElementById('tagInput').value = currentTags;
            renderTagSuggestions(currentTags);
            document.getElementById('tagModal').classList.add('show');
            document.getElementById('tagInput').focus();
        }
        function closeTagEditor() {
            document.getElementById('tagModal').classList.remove('show');
            currentBookId = null;
        }
        async function saveTags() {
            if (!currentBookId) return;
            const tags = document.getElementById('tagInput').value.split(',').map(t => t.trim()).filter(t => t);
            try {
                const res = await fetch(`{{ root_path }}/api/books/${currentBookId}/tags`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tags })
                });
                if (!res.ok) { alert(`Failed: ${(await res.json()).detail || 'Unknown error'}`); return; }
                window.location.reload();
            } catch (err) { alert(`Failed: ${err.message}`); }
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeTagEditor(); });

        // These event listeners are attached after DOM is ready (elements are below this script)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tagModal')?.addEventListener('click', (e) => { if (e.target.id === 'tagModal') closeTagEditor(); });
            document.getElementById('tagInput')?.addEventListener('input', (e) => {
                renderTagSuggestions(e.target.value);
            });
        });

        async function toggleCompleted(bookId, checkbox) {
            // checkbox.checked already reflects the new state after user clicked
            const newCompleted = checkbox.checked;
            try {
                const res = await fetch(`{{ root_path }}/api/books/${bookId}/completed`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: newCompleted })
                });
                if (!res.ok) {
                    alert(`Failed: ${(await res.json()).detail || 'Unknown error'}`);
                    return;
                }
                window.location.reload();
            } catch (err) {
                alert(`Failed: ${err.message}`);
            }
        }
    </script>

    <div id="tagModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Edit Tags</h2>
            <p class="modal-subtitle" id="modalBookTitle"></p>
            <input type="text" id="tagInput" class="modal-input" placeholder="Enter tags separated by commas">
            <div class="tag-suggestions" id="tagSuggestions">
                <span class="tag-suggestions-label">Existing tags:</span>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeTagEditor()">Cancel</button>
                <button class="modal-btn modal-btn-save" onclick="saveTags()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content delete-modal">
            <h2 class="modal-title">Delete Book</h2>
            <p class="modal-subtitle">Delete "<span id="deleteBookTitle"></span>"?</p>
            <p class="delete-warning">
                This will permanently remove the book and all associated data including:
            </p>
            <ul class="delete-list">
                <li>Reading progress</li>
                <li>Highlights and notes</li>
                <li>Book files</li>
            </ul>
            <p class="delete-warning"><strong>This action cannot be undone.</strong></p>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let deleteBookId = null;

        function openDeleteModal(bookId, bookTitle) {
            deleteBookId = bookId;
            document.getElementById('deleteBookTitle').textContent = bookTitle;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            deleteBookId = null;
            document.getElementById('deleteModal').classList.remove('show');
        }

        async function confirmDelete() {
            if (!deleteBookId) return;

            const deleteBtn = document.querySelector('.modal-btn-danger');
            deleteBtn.textContent = 'Deleting...';
            deleteBtn.disabled = true;

            try {
                const response = await fetch(`{{ root_path }}/api/books/${deleteBookId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    closeDeleteModal();
                    window.location.reload();
                } else {
                    alert('Failed to delete book: ' + (result.detail || 'Unknown error'));
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.disabled = false;
                }
            } catch (error) {
                alert('Failed to delete book. Please try again.');
                console.error('Delete error:', error);
                deleteBtn.textContent = 'Delete';
                deleteBtn.disabled = false;
            }
        }

        // Close delete modal on backdrop click
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') closeDeleteModal();
        });
    </script>

    <!-- Offline Support -->
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('{{ root_path }}/sw.js', { scope: '{{ root_path }}/' })
                .then(reg => console.log('[Offline] Service Worker registered'))
                .catch(err => console.error('[Offline] SW registration failed:', err));
        }

        // Update online/offline status
        function updateOnlineStatus() {
            const el = document.getElementById('offlineStatus');
            if (navigator.onLine) {
                el.textContent = '‚óè Online';
                el.className = 'offline-status online';
            } else {
                el.textContent = '‚úà Offline';
                el.className = 'offline-status offline';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // Sync when coming back online
        window.addEventListener('online', async () => {
            if (window.OfflineDB) {
                const result = await window.OfflineDB.flushOutbox();
                if (result.success > 0) {
                    console.log(`[Offline] Synced ${result.success} items`);
                }
            }
        });

        // Update storage usage display
        async function updateStorageUsage() {
            if (!window.OfflineDB) return;
            const el = document.getElementById('storageUsage');
            try {
                const usage = await window.OfflineDB.getStorageUsage();
                if (usage.total > 0) {
                    el.textContent = `üì¶ ${window.OfflineDB.formatBytes(usage.total)} (${usage.bookCount} books)`;
                    el.classList.add('has-data');
                } else {
                    el.textContent = 'üì¶ No offline data';
                    el.classList.remove('has-data');
                }
            } catch (e) {
                el.textContent = 'üì¶ --';
            }
        }

        function showStorageDetails() {
            if (!window.OfflineDB) return;
            window.OfflineDB.getStorageUsage().then(usage => {
                const details = [
                    `Offline Storage Usage`,
                    `---`,
                    `Books: ${usage.bookCount}`,
                    `Chapters: ${window.OfflineDB.formatBytes(usage.chapters)}`,
                    `Images: ${window.OfflineDB.formatBytes(usage.images)}`,
                    `Metadata: ${window.OfflineDB.formatBytes(usage.books)}`,
                    `---`,
                    `Total: ${window.OfflineDB.formatBytes(usage.total)}`,
                    ``,
                    `Books expire after ${(window.OfflineDB.TTL_MS / 1000 / 60 / 60 / 24).toFixed(0)} days.`,
                    `Max ${window.OfflineDB.MAX_BOOKS} books stored (LRU eviction).`
                ].join('\n');
                alert(details);
            });
        }

        // Mark downloaded books on page load
        async function markDownloadedBooks() {
            if (!window.OfflineDB) return;

            // Run cleanup first (TTL + LRU)
            await window.OfflineDB.runCleanup();

            const downloadedBooks = await window.OfflineDB.getDownloadedBooks();
            const downloadedIds = new Set(downloadedBooks.map(b => b.book_id));

            document.querySelectorAll('.book-offline-btn').forEach(btn => {
                const bookId = btn.dataset.bookId;
                if (downloadedIds.has(bookId)) {
                    btn.classList.add('downloaded');
                    btn.title = 'Downloaded for offline (click to remove)';
                    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg>';
                }
            });

            // Update storage usage after marking books
            await updateStorageUsage();
        }
        markDownloadedBooks();

        // Toggle offline download
        async function toggleOfflineDownload(bookId, btn) {
            if (!window.OfflineDB) {
                alert('Offline storage not available');
                return;
            }

            const isDownloaded = await window.OfflineDB.isBookDownloaded(bookId);

            if (isDownloaded) {
                // Remove download
                if (confirm('Remove offline download?')) {
                    await window.OfflineDB.removeDownloadedBook(bookId);
                    btn.classList.remove('downloaded');
                    btn.title = 'Download for offline';
                    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>';
                    await updateStorageUsage();
                }
            } else {
                // Download
                btn.classList.add('downloading');
                btn.title = 'Downloading...';
                btn.innerHTML = '‚è≥';

                try {
                    await window.OfflineDB.downloadBook(bookId, (completed, total) => {
                        btn.innerHTML = `${completed}/${total}`;
                    });

                    btn.classList.remove('downloading');
                    btn.classList.add('downloaded');
                    btn.title = 'Downloaded for offline (click to remove)';
                    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg>';

                    // Refresh UI to update other buttons if LRU eviction happened
                    markDownloadedBooks();
                    await updateStorageUsage();
                } catch (err) {
                    console.error('[Offline] Download failed:', err);
                    btn.classList.remove('downloading');
                    btn.title = 'Download failed - click to retry';
                    btn.innerHTML = '‚ùå';
                    alert('Download failed: ' + err.message);
                }
            }
        }
    </script>
</body>
</html>
