<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Reader</title>
    <link rel="stylesheet" href="/reader/static/theme.css">
    <style>
        :root {
            --bg-main: #ffffff;
            --bg-sidebar: #f8f9fa;
            --bg-button: #f8f9fa;
            --bg-button-hover: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-light: #e9ecef;
            --border-medium: #dee2e6;
            --accent-primary: #3498db;
            --heading-color: #333333;
        }

        body.dark-mode {
            --bg-main: #1a1a1a;
            --bg-sidebar: #2d2d2d;
            --bg-button: #3d3d3d;
            --bg-button-hover: #4a4a4a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #888888;
            --border-light: #3d3d3d;
            --border-medium: #4a4a4a;
            --accent-primary: #7db8f5;
            --heading-color: #d4d4d4;
        }

        body { margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; font-family: "Georgia", serif; background: var(--bg-main); }
        #sidebar { width: 300px; background: var(--bg-sidebar); border-right: 1px solid var(--border-light); overflow-y: auto; padding: 60px 20px 20px 20px; flex-shrink: 0; }
        body.sidebar-collapsed #sidebar { display: none; }
        .nav-header { font-family: -apple-system, sans-serif; font-weight: bold; color: var(--text-secondary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-medium); }
        .nav-home { display: block; margin-bottom: 20px; color: var(--accent-primary); text-decoration: none; font-family: -apple-system, sans-serif; font-size: 0.9em; }
        ul.toc-list { list-style: none; padding-left: 0; margin: 0; }
        ul.toc-list ul { padding-left: 20px; }
        li.toc-item { margin-bottom: 8px; }
        a.toc-link { text-decoration: none; color: var(--text-secondary); font-size: 0.95em; display: block; padding: 4px 8px; line-height: 1.4; border-radius: 4px; cursor: pointer; }
        a.toc-link:hover { color: var(--text-primary); background: var(--bg-button-hover); }
        a.toc-link.active { color: #dc2626; font-weight: bold; }
        #main { flex-grow: 1; overflow-y: auto; position: relative; background: var(--bg-main); }
        .content-container { max-width: 700px; margin: 0 auto; padding: 60px 40px; line-height: 1.8; font-size: 1.15em; color: var(--text-primary); }
        body.sidebar-collapsed .content-container { max-width: 900px; }
        .book-content img { max-width: 100%; height: auto; display: block; margin: 20px auto; }
        .book-content h1, .book-content h2, .book-content h3 { font-family: -apple-system, sans-serif; margin-top: 1.5em; color: var(--heading-color); }
        .book-content p { margin-bottom: 1.5em; text-align: justify; }
        .top-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 15; }
        .top-btn { background: var(--bg-button); color: var(--text-secondary); border: 1px solid var(--border-medium); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2em; }
        .sidebar-toggle { position: fixed; top: 20px; left: 20px; background: var(--bg-button); color: var(--text-secondary); border: 1px solid var(--border-medium); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2em; z-index: 20; }
        .chapter-nav { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; border-top: 1px solid var(--border-light); font-family: -apple-system, sans-serif; }
        .nav-btn { text-decoration: none; color: var(--accent-primary); font-weight: bold; padding: 10px 20px; border: 1px solid var(--accent-primary); border-radius: 4px; cursor: pointer; background: none; }
        .nav-btn:hover { background: var(--accent-primary); color: white; }
        .nav-btn.disabled { opacity: 0.5; pointer-events: none; }
        .offline-badge { position: fixed; top: 20px; right: 20px; background: #f59e0b; color: white; padding: 4px 12px; border-radius: 4px; font-family: -apple-system, sans-serif; font-size: 0.8em; font-weight: 500; z-index: 100; }
        .loading { text-align: center; padding: 100px 20px; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="offline-badge">✈ Offline</div>

    <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>

    <div id="sidebar">
        <a href="/reader/" class="nav-home">← Library</a>
        <div class="nav-header" id="bookTitle">Loading...</div>
        <ul class="toc-list" id="tocList"></ul>
    </div>

    <div id="main">
        <div class="content-container">
            <div id="chapterContent" class="book-content">
                <div class="loading">Loading offline content...</div>
            </div>

            <div class="chapter-nav">
                <button class="nav-btn" id="prevBtn" onclick="navigateChapter(-1)">← Previous</button>
                <button class="nav-btn" id="nextBtn" onclick="navigateChapter(1)">Next →</button>
            </div>
        </div>
    </div>

    <script src="/reader/static/offline-db.js"></script>
    <script src="/reader/static/theme-toggle.js"></script>
    <script>
        let currentBookId = null;
        let currentChapterIndex = 0;
        let bookData = null;

        async function init() {
            // Parse URL to get book_id and chapter
            const match = window.location.pathname.match(/\/reader\/read\/([^/]+)\/(\d+)/);
            if (!match) {
                showError('Invalid URL');
                return;
            }

            currentBookId = match[1];
            currentChapterIndex = parseInt(match[2], 10);

            // Load book metadata
            bookData = await window.OfflineDB.getBook(currentBookId);
            if (!bookData) {
                showError('Book not available offline. Please download it first.');
                return;
            }

            // Update last read time
            await window.OfflineDB.updateBookAccess(currentBookId);

            // Render TOC
            document.getElementById('bookTitle').textContent = bookData.title;
            renderTOC(bookData.toc);

            // Load chapter
            await loadChapter(currentChapterIndex);

            // Update nav buttons
            updateNavButtons();
        }

        function renderTOC(toc, container = null) {
            if (!container) {
                container = document.getElementById('tocList');
                container.innerHTML = '';
            }

            for (const entry of toc) {
                const li = document.createElement('li');
                li.className = 'toc-item';

                const a = document.createElement('a');
                a.className = 'toc-link';
                a.textContent = entry.title;

                // Find chapter index by file_href
                const spineIdx = bookData.spine.findIndex(s => s.href === entry.file_href);
                if (spineIdx !== -1) {
                    a.onclick = () => {
                        currentChapterIndex = spineIdx;
                        loadChapter(spineIdx);
                        updateNavButtons();
                        history.pushState(null, '', `/reader/read/${currentBookId}/${spineIdx}`);
                    };
                    if (spineIdx === currentChapterIndex) {
                        a.classList.add('active');
                    }
                }

                li.appendChild(a);

                if (entry.children && entry.children.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'toc-list';
                    renderTOC(entry.children, ul);
                    li.appendChild(ul);
                }

                container.appendChild(li);
            }
        }

        async function loadChapter(index) {
            const chapter = await window.OfflineDB.getChapter(currentBookId, index);
            if (!chapter) {
                showError(`Chapter ${index} not available offline`);
                return;
            }

            document.getElementById('chapterContent').innerHTML = chapter.html;

            // Scroll to top
            document.getElementById('main').scrollTop = 0;

            // Update active state in TOC
            document.querySelectorAll('.toc-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.toc-link[data-index="${index}"]`);
            if (activeLink) activeLink.classList.add('active');
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (currentChapterIndex <= 0) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }

            if (currentChapterIndex >= bookData.spine_len - 1) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        }

        function navigateChapter(delta) {
            const newIndex = currentChapterIndex + delta;
            if (newIndex < 0 || newIndex >= bookData.spine_len) return;

            currentChapterIndex = newIndex;
            loadChapter(newIndex);
            updateNavButtons();
            history.pushState(null, '', `/reader/read/${currentBookId}/${newIndex}`);
        }

        function showError(message) {
            document.getElementById('chapterContent').innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <h2 style="color: #dc2626;">Offline Error</h2>
                    <p style="color: var(--text-muted);">${message}</p>
                    <a href="/reader/" style="color: var(--accent-primary);">← Back to Library</a>
                </div>
            `;
        }

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-collapsed');
        }

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            const match = window.location.pathname.match(/\/reader\/read\/([^/]+)\/(\d+)/);
            if (match && match[1] === currentBookId) {
                currentChapterIndex = parseInt(match[2], 10);
                loadChapter(currentChapterIndex);
                updateNavButtons();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') navigateChapter(-1);
            if (e.key === 'ArrowRight') navigateChapter(1);
        });

        // Initialize
        init();
    </script>
</body>
</html>
